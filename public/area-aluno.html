<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Aluno - Certificar</title>
    <style>
        :root {
            --primary-blue: #3B82F6;
            --success-green: #10B981;
            --accent-orange: #F59E0B;
            --dark-gray: #1E293B;
            --white: #FFFFFF;
            --light-gray: #F8F9FA;
            --border-radius: 8px;
            --transition: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        /* Auth Container */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: var(--white);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .auth-card h1 {
            color: var(--primary-blue);
            margin-bottom: 10px;
            font-size: 28px;
        }

        .auth-card p {
            color: #64748b;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color var(--transition);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            width: 100%;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #64748b;
        }

        .auth-switch a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success-green);
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: var(--primary-blue);
            color: var(--white);
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--white);
            color: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 8px 16px;
            border: 1px solid var(--white);
        }

        .btn-logout:hover {
            background: var(--white);
            color: var(--primary-blue);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            color: #64748b;
            transition: all var(--transition);
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .tab:hover {
            color: var(--primary-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-card.blue .value {
            color: var(--primary-blue);
        }

        .stat-card.green .value {
            color: var(--success-green);
        }

        .stat-card.orange .value {
            color: var(--accent-orange);
        }

        .card {
            background: var(--white);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--dark-gray);
            margin-bottom: 20px;
            font-size: 20px;
        }

        .course-item {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            transition: all var(--transition);
        }

        .course-item:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .course-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-progress {
            background: #dbeafe;
            color: var(--primary-blue);
        }

        .badge-completed {
            background: #d1fae5;
            color: var(--success-green);
        }

        .badge-orange {
            background: #fef3c7;
            color: var(--accent-orange);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), #60a5fa);
            transition: width var(--transition);
        }

        .progress-text {
            font-size: 14px;
            color: #64748b;
            margin-top: 8px;
        }

        .profile-form {
            max-width: 600px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .certificate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            transition: all var(--transition);
        }

        .certificate-item:hover {
            border-color: var(--success-green);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .certificate-info h3 {
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .certificate-date {
            color: #64748b;
            font-size: 14px;
        }

        .btn-download {
            background: var(--success-green);
            color: var(--white);
            padding: 10px 20px;
            width: auto;
        }

        .btn-download:hover {
            background: #059669;
        }

        /* Materials Tab */
        .module-card {
            background: var(--white);
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            transition: all var(--transition);
        }

        .module-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .module-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .module-count {
            background: #dbeafe;
            color: var(--primary-blue);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .material-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            transition: all var(--transition);
        }

        .material-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }

        .material-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .material-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
            border-radius: var(--border-radius);
        }

        .material-details {
            flex: 1;
        }

        .material-name {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 4px;
        }

        .material-meta {
            font-size: 12px;
            color: #64748b;
        }

        .btn-material-download {
            background: var(--primary-blue);
            color: var(--white);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-material-download:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .material-viewed {
            opacity: 0.6;
        }

        .material-viewed .material-name::after {
            content: ' ‚úì';
            color: var(--success-green);
        }

        .hidden {
            display: none;
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--white);
            margin-top: 20px;
            font-size: 16px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--accent-orange);
        }

        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .course-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .certificate-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Carregando...</div>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div id="loginForm">
                <h1>Bem-vindo de volta!</h1>
                <p>Entre na sua conta para continuar</p>

                <div id="loginAlert" class="alert"></div>

                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required placeholder="seu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                    <a href="/" class="btn btn-secondary" style="display: block; text-align: center; margin-top: 10px; text-decoration: none;">‚Üê Voltar ao Site</a>
                </form>

                <div class="auth-switch">
                    N√£o tem uma conta? <a href="#" onclick="showSignup(); return false;">Cadastre-se</a>
                </div>
            </div>

            <div id="signupForm" class="hidden">
                <h1>Criar conta</h1>
                <p>Preencha os dados para come√ßar</p>

                <div id="signupAlert" class="alert"></div>

                <form onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>C√≥digo de Acesso</label>
                        <input type="text" id="signupCodigoAcesso" required placeholder="Digite seu c√≥digo de acesso" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Nome completo</label>
                        <input type="text" id="signupName" required placeholder="Seu nome completo">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" required placeholder="seu@email.com">
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" id="signupPassword" required placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="signupPhone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="signupCity" placeholder="Sua cidade">
                    </div>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                    <a href="/" class="btn btn-secondary" style="display: block; text-align: center; margin-top: 10px; text-decoration: none;">‚Üê Voltar ao Site</a>
                </form>

                <div class="auth-switch">
                    J√° tem uma conta? <a href="#" onclick="showLogin(); return false;">Entrar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <header class="header">
            <div class="header-content">
                <h1>√Årea do Aluno</h1>
                <div class="user-info">
                    <a href="/" class="btn btn-secondary" style="margin-right: 10px;">‚Üê Voltar ao Site</a>
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Usu√°rio</span>
                    <button class="btn btn-logout" onclick="handleLogout()">Sair</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">Vis√£o Geral</button>
                <button class="tab" onclick="switchTab('courses')">Meus Cursos</button>
                <button class="tab" onclick="switchTab('materials')">Materiais</button>
                <button class="tab" onclick="switchTab('certificates')">Certificados</button>
                <button class="tab" onclick="switchTab('profile')">Perfil</button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <h3>Cursos Matriculados</h3>
                        <div class="value" id="statTotalCursos">0</div>
                        <p>Ativos no momento</p>
                    </div>
                    <div class="stat-card green">
                        <h3>Cursos Conclu√≠dos</h3>
                        <div class="value" id="statCursosCompletos">0</div>
                        <p>Certificados emitidos</p>
                    </div>
                    <div class="stat-card orange">
                        <h3>Horas de Estudo</h3>
                        <div class="value" id="statHorasEstudo">0h</div>
                        <p>Total acumulado</p>
                    </div>
                </div>

                <div class="card">
                    <h2>Cursos em Andamento</h2>
                    <div id="cursosAndamentoContainer">
                        <p style="color: #64748b; text-align: center; padding: 40px;">Carregando cursos...</p>
                    </div>
                </div>
            </div>

            <!-- Courses Tab -->
            <div id="coursesTab" class="tab-content">
                <div class="card">
                    <h2>Todos os Meus Cursos</h2>
                    <div id="todosCursosContainer">
                        <p style="color: #64748b; text-align: center; padding: 40px;">Carregando cursos...</p>
                    </div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div id="materialsTab" class="tab-content">
                <div class="card">
                    <h2>Materiais de Estudo</h2>
                    <div id="materialsContainer">
                        <p style="color: #64748b; text-align: center; padding: 40px;">Carregando materiais...</p>
                    </div>
                </div>
            </div>

            <!-- Certificates Tab -->
            <div id="certificatesTab" class="tab-content">
                <div class="card">
                    <h2>Meus Certificados</h2>
                    <div id="certificadosContainer">
                        <p style="color: #64748b; text-align: center; padding: 40px;">Carregando certificados...</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content">
                <div class="card">
                    <h2>Meu Perfil</h2>
                    <form class="profile-form" onsubmit="handleProfileUpdate(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome completo</label>
                                <input type="text" id="profileName" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="profileEmail" disabled>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="tel" id="profilePhone">
                            </div>
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" id="profileCity">
                            </div>
                        </div>
                        <div id="profileAlert" class="alert"></div>
                        <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // CONFIGURA√á√ÉO DO SUPABASE
        const SUPABASE_URL = 'https://jfgnelowaaiwuzwelbot.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmZ25lbG93YWFpd3V6d2VsYm90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjU4OTYsImV4cCI6MjA3NTI0MTg5Nn0.xp9ypKx0mtbHjs-TGinWSKqebua8Bcx9hwYKVE_UA2Y';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Vari√°vel global para o usu√°rio
        let currentUser = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        // Verificar autentica√ß√£o
        async function checkAuth() {
            showLoading('Verificando autentica√ß√£o...');

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (session) {
                    currentUser = session.user;
                    showDashboard();
                    await loadUserData();
                } else {
                    showAuth();
                }
            } catch (err) {
                console.error('Erro ao verificar autentica√ß√£o:', err);
                showAuth();
            } finally {
                hideLoading();
            }
        }

        // Mostrar tela de autentica√ß√£o
        function showAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // Alternar entre login e cadastro
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // Loading Overlay
        function showLoading(text = 'Carregando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.classList.add('show');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('show');
        }

        // Mostrar alerta
        function showAlert(elementId, message, isSuccess, isWarning = false) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            if (isWarning) {
                alert.className = 'alert alert-warning';
            } else {
                alert.className = isSuccess ? 'alert alert-success' : 'alert alert-error';
            }
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Login
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            showLoading('Entrando...');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    hideLoading();
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    showAlert('loginAlert', error.message, false);
                } else {
                    currentUser = data.user;
                    hideLoading();
                    showDashboard();
                    loadUserData();
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                }
            } catch (err) {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                showAlert('loginAlert', 'Erro ao fazer login. Tente novamente.', false);
            }
        }

        // Validar email autorizado
        async function validarEmailAutorizado(email) {
            const emailLower = email.toLowerCase().trim();

            const { data, error } = await supabaseClient
                .from('emails_autorizados')
                .select('*')
                .eq('email', emailLower)
                .eq('autorizado', true)
                .single();

            if (error || !data) {
                return {
                    valido: false,
                    mensagem: 'Este email n√£o est√° autorizado. Entre em contato conosco.'
                };
            }

            return { valido: true, emailData: data };
        }

        // Validar c√≥digo de acesso
        async function validarCodigoAcesso(codigo) {
            const codigoUpper = codigo.toUpperCase().trim();

            const { data, error } = await supabaseClient
                .from('codigos_acesso')
                .select('*')
                .eq('codigo', codigoUpper)
                .eq('usado', false)
                .single();

            if (error || !data) {
                return { valido: false, mensagem: 'C√≥digo de acesso inv√°lido ou j√° utilizado.' };
            }

            return { valido: true, codigoData: data };
        }

        // Cadastro
        async function handleSignup(event) {
            event.preventDefault();

            const codigoAcesso = document.getElementById('signupCodigoAcesso').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            const phone = document.getElementById('signupPhone').value;
            const city = document.getElementById('signupCity').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            showLoading('Validando c√≥digo de acesso...');

            try {
                // 1. Validar email autorizado
                showLoading('Verificando autoriza√ß√£o...');
                const validacaoEmail = await validarEmailAutorizado(email);

                if (!validacaoEmail.valido) {
                    hideLoading();
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    showAlert('signupAlert', validacaoEmail.mensagem, false);
                    return;
                }

                // 2. Validar c√≥digo de acesso
                showLoading('Validando c√≥digo de acesso...');
                const validacaoCodigo = await validarCodigoAcesso(codigoAcesso);

                if (!validacaoCodigo.valido) {
                    hideLoading();
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    showAlert('signupAlert', validacaoCodigo.mensagem, false);
                    return;
                }

                showLoading('Criando conta...');

                // 3. Criar usu√°rio no Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name,
                            phone: phone,
                            city: city
                        }
                    }
                });

                if (authError) {
                    hideLoading();
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                    showAlert('signupAlert', authError.message, false);
                    return;
                }

                const userId = authData.user.id;

                // 4. Marcar c√≥digo como usado
                showLoading('Ativando acesso ao curso...');

                const { error: updateCodigoError } = await supabaseClient
                    .from('codigos_acesso')
                    .update({
                        usado: true,
                        user_id: userId,
                        data_uso: new Date().toISOString()
                    })
                    .eq('codigo', codigoAcesso.toUpperCase().trim());

                if (updateCodigoError) {
                    console.error('Erro ao atualizar c√≥digo:', updateCodigoError);
                }

                // 5. Coletar IDs de cursos para matr√≠cula
                const cursosParaMatricular = [];

                // Curso do c√≥digo de acesso
                if (validacaoCodigo.codigoData.curso_id) {
                    cursosParaMatricular.push(validacaoCodigo.codigoData.curso_id);
                }

                // Curso do email autorizado
                if (validacaoEmail.emailData.curso_id) {
                    cursosParaMatricular.push(validacaoEmail.emailData.curso_id);
                }

                // Remover duplicatas
                const cursosUnicos = [...new Set(cursosParaMatricular)];

                // 6. Criar matr√≠culas autom√°ticas
                if (cursosUnicos.length > 0) {
                    const matriculas = cursosUnicos.map(cursoId => ({
                        aluno_id: userId,
                        curso_id: cursoId,
                        progresso: 0,
                        data_matricula: new Date().toISOString()
                    }));

                    const { error: matriculaError } = await supabaseClient
                        .from('matriculas')
                        .insert(matriculas);

                    if (matriculaError) {
                        console.error('Erro ao criar matr√≠culas:', matriculaError);
                    }
                }

                // 7. Criar perfil
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert({
                        id: userId,
                        email: email,
                        full_name: name,
                        phone: phone,
                        city: city
                    });

                if (profileError) {
                    console.error('Erro ao criar perfil:', profileError);
                }

                hideLoading();
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');

                showAlert('signupAlert', 'Cadastro realizado! Verifique seu email para confirmar.', true);
                setTimeout(() => {
                    showLogin();
                }, 3000);

            } catch (err) {
                console.error('Erro no cadastro:', err);
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                showAlert('signupAlert', 'Erro ao criar conta. Tente novamente.', false);
            }
        }

        // Logout
        async function handleLogout() {
            showLoading('Saindo...');

            try {
                const { error } = await supabaseClient.auth.signOut();

                if (!error) {
                    currentUser = null;
                    hideLoading();
                    showAuth();
                    showLogin();
                } else {
                    hideLoading();
                    alert('Erro ao fazer logout');
                }
            } catch (err) {
                hideLoading();
                alert('Erro ao fazer logout');
            }
        }

        // Carregar dados do usu√°rio
        async function loadUserData() {
            if (!currentUser) return;

            const metadata = currentUser.user_metadata || {};
            const name = metadata.full_name || currentUser.email.split('@')[0];

            // Atualizar header
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();

            // Atualizar formul√°rio de perfil
            document.getElementById('profileName').value = metadata.full_name || '';
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = metadata.phone || '';
            document.getElementById('profileCity').value = metadata.city || '';

            // Carregar dados do perfil do banco
            try {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profile) {
                    document.getElementById('profileName').value = profile.full_name || metadata.full_name || '';
                    document.getElementById('profilePhone').value = profile.phone || metadata.phone || '';
                    document.getElementById('profileCity').value = profile.city || metadata.city || '';
                }
            } catch (err) {
                console.log('Perfil ainda n√£o criado no banco');
            }

            // Carregar estat√≠sticas e cursos
            await loadDashboardData();
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            if (!currentUser) {
                console.error('‚ùå Usu√°rio n√£o autenticado');
                return;
            }

            console.log('üë§ Carregando dados para usu√°rio:', currentUser.id);

            try {
                // Buscar matr√≠culas do aluno
                console.log('üîç Buscando matr√≠culas do aluno...');

                const { data: matriculas, error: matriculasError } = await supabaseClient
                    .from('matriculas')
                    .select(`
                        *,
                        cursos (
                            id,
                            titulo,
                            carga_horaria,
                            descricao
                        )
                    `)
                    .eq('aluno_id', currentUser.id);

                console.log('üìã Matr√≠culas encontradas:', matriculas);

                if (matriculasError) {
                    console.error('Erro ao carregar matr√≠culas:', matriculasError);
                    return;
                }

                // Calcular estat√≠sticas
                const totalCursos = matriculas?.length || 0;
                const cursosCompletos = matriculas?.filter(m => m.progresso === 100).length || 0;
                const totalHoras = matriculas?.reduce((acc, m) => {
                    const horas = m.cursos?.carga_horaria || 0;
                    const percentual = m.progresso || 0;
                    return acc + (horas * percentual / 100);
                }, 0) || 0;

                // Atualizar estat√≠sticas na UI
                updateStatistics(totalCursos, cursosCompletos, Math.round(totalHoras));

                // Renderizar cursos
                if (matriculas && matriculas.length > 0) {
                    renderCourses(matriculas);
                }

                // Carregar materiais
                await loadMaterials(matriculas);

            } catch (err) {
                console.error('Erro ao carregar dados do dashboard:', err);
            }
        }

        // Carregar materiais de estudo
        async function loadMaterials(matriculas) {
            if (!matriculas || matriculas.length === 0) {
                document.getElementById('materialsContainer').innerHTML =
                    '<p style="color: #64748b; text-align: center; padding: 40px;">Voc√™ ainda n√£o est√° matriculado em nenhum curso.</p>';
                return;
            }

            try {
                // Extrair IDs dos cursos matriculados
                const cursosIds = matriculas.map(m => m.curso_id);

                // Buscar materiais dos cursos
                console.log('üîç Buscando materiais para cursos:', cursosIds);

                const { data: materiais, error: materiaisError } = await supabaseClient
                    .from('materiais')
                    .select('*')
                    .in('curso_id', cursosIds)
                    .order('modulo', { ascending: true })
                    .order('created_at', { ascending: true });

                console.log('üìö Materiais encontrados:', materiais);

                if (materiaisError) {
                    console.error('Erro ao carregar materiais:', materiaisError);
                    document.getElementById('materialsContainer').innerHTML =
                        '<p style="color: #ef4444; text-align: center; padding: 40px;">Erro ao carregar materiais.</p>';
                    return;
                }

                if (!materiais || materiais.length === 0) {
                    document.getElementById('materialsContainer').innerHTML =
                        '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum material dispon√≠vel no momento.</p>';
                    return;
                }

                // Agrupar materiais por m√≥dulo
                const materiaisPorModulo = {};
                materiais.forEach(material => {
                    const modulo = material.modulo || 'Geral';
                    if (!materiaisPorModulo[modulo]) {
                        materiaisPorModulo[modulo] = [];
                    }
                    materiaisPorModulo[modulo].push(material);
                });

                // Renderizar materiais
                renderMaterials(materiaisPorModulo);

            } catch (err) {
                console.error('Erro ao carregar materiais:', err);
                document.getElementById('materialsContainer').innerHTML =
                    '<p style="color: #ef4444; text-align: center; padding: 40px;">Erro ao carregar materiais.</p>';
            }
        }

        // Obter √≠cone por tipo de material
        function getMaterialIcon(tipo) {
            const icons = {
                'pdf': 'üìÑ',
                'video': 'üé•',
                'exercicio': 'üìù',
                'documento': 'üìÑ',
                'apresentacao': 'üìä',
                'link': 'üîó',
                'arquivo': 'üìé'
            };
            return icons[tipo?.toLowerCase()] || 'üìé';
        }

        // Renderizar materiais
        function renderMaterials(materiaisPorModulo) {
            const container = document.getElementById('materialsContainer');

            const html = Object.keys(materiaisPorModulo).map(modulo => {
                const materiais = materiaisPorModulo[modulo];
                const count = materiais.length;

                const materiaisHTML = materiais.map(material => {
                    const icon = getMaterialIcon(material.tipo);
                    const viewed = material.visualizado ? 'material-viewed' : '';

                    return `
                        <div class="material-item ${viewed}">
                            <div class="material-info">
                                <div class="material-icon">${icon}</div>
                                <div class="material-details">
                                    <div class="material-name">${material.titulo}</div>
                                    <div class="material-meta">${material.tipo || 'Documento'} ${material.tamanho ? '¬∑ ' + material.tamanho : ''}</div>
                                </div>
                            </div>
                            <button class="btn-material-download" onclick="downloadMaterial('${material.id}', '${material.arquivo_path}', '${material.titulo}')">
                                <span>‚¨á</span> Download
                            </button>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-title">${modulo}</div>
                            <div class="module-count">${count} ${count === 1 ? 'material' : 'materiais'}</div>
                        </div>
                        ${materiaisHTML}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Download de material
        async function downloadMaterial(materialId, storagePath, titulo) {
            console.log('‚¨áÔ∏è Tentando download:', {
                materialId: materialId,
                arquivo_path: storagePath,
                titulo: titulo
            });

            if (!storagePath) {
                console.error('‚ùå Caminho do arquivo n√£o encontrado');
                alert('Caminho do arquivo n√£o encontrado.');
                return;
            }

            showLoading('Preparando download...');

            try {
                // Criar URL assinada para download seguro
                const { data, error } = await supabaseClient
                    .storage
                    .from('course-materials')
                    .createSignedUrl(storagePath, 60); // 60 segundos de validade

                hideLoading();

                if (error) {
                    console.error('Erro ao gerar URL de download:', error);
                    alert('Erro ao preparar download. Tente novamente.');
                    return;
                }

                if (data && data.signedUrl) {
                    // Abrir URL em nova aba
                    window.open(data.signedUrl, '_blank');

                    // Marcar material como visualizado (opcional)
                    await markMaterialAsViewed(materialId);
                } else {
                    alert('Erro ao gerar link de download.');
                }

            } catch (err) {
                hideLoading();
                console.error('Erro no download:', err);
                alert('Erro ao fazer download. Tente novamente.');
            }
        }

        // Marcar material como visualizado
        async function markMaterialAsViewed(materialId) {
            try {
                const { error } = await supabaseClient
                    .from('materiais')
                    .update({ visualizado: true })
                    .eq('id', materialId);

                if (error) {
                    console.error('Erro ao marcar como visualizado:', error);
                }
            } catch (err) {
                console.error('Erro:', err);
            }
        }

        // Atualizar estat√≠sticas
        function updateStatistics(totalCursos, cursosCompletos, totalHoras) {
            console.log('üìä Atualizando estat√≠sticas:', { totalCursos, cursosCompletos, totalHoras });

            document.getElementById('statTotalCursos').textContent = totalCursos;
            document.getElementById('statCursosCompletos').textContent = cursosCompletos;
            document.getElementById('statHorasEstudo').textContent = totalHoras + 'h';
        }

        // Renderizar cursos
        function renderCourses(matriculas) {
            console.log('üéì Renderizando cursos:', matriculas);

            if (!matriculas || matriculas.length === 0) {
                document.getElementById('cursosAndamentoContainer').innerHTML =
                    '<p style="color: #64748b; text-align: center; padding: 40px;">Voc√™ ainda n√£o est√° matriculado em nenhum curso.</p>';
                document.getElementById('todosCursosContainer').innerHTML =
                    '<p style="color: #64748b; text-align: center; padding: 40px;">Voc√™ ainda n√£o est√° matriculado em nenhum curso.</p>';
                return;
            }

            // Cursos em andamento (Overview)
            const cursosEmAndamento = matriculas.filter(m => m.progresso > 0 && m.progresso < 100);
            const andamentoContainer = document.getElementById('cursosAndamentoContainer');

            if (cursosEmAndamento.length > 0) {
                andamentoContainer.innerHTML = cursosEmAndamento.map(m => createCourseHTML(m)).join('');
            } else {
                andamentoContainer.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum curso em andamento.</p>';
            }

            // Todos os cursos (Cursos Tab)
            const todosContainer = document.getElementById('todosCursosContainer');
            todosContainer.innerHTML = matriculas.map(m => createCourseHTML(m)).join('');

            // Certificados
            const certificadosCompletos = matriculas.filter(m => m.progresso === 100);
            if (certificadosCompletos.length > 0) {
                renderCertificates(certificadosCompletos);
            } else {
                document.getElementById('certificadosContainer').innerHTML =
                    '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum certificado dispon√≠vel ainda.</p>';
            }
        }

        // Criar HTML de curso
        function createCourseHTML(matricula) {
            const curso = matricula.cursos;
            const progresso = matricula.progresso || 0;
            const status = progresso === 100 ? 'Conclu√≠do' : 'Em progresso';
            const badgeClass = progresso === 100 ? 'badge-completed' : 'badge-progress';
            const horasRestantes = curso.carga_horaria ? Math.round(curso.carga_horaria * (100 - progresso) / 100) : 0;
            const progressoTexto = progresso === 100
                ? '100% conclu√≠do'
                : `${progresso}% conclu√≠do ¬∑ ${horasRestantes}h restantes`;

            return `
                <div class="course-item">
                    <div class="course-header">
                        <div class="course-title">${curso.titulo || 'Curso sem t√≠tulo'}</div>
                        <span class="badge ${badgeClass}">${status}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progresso}%"></div>
                    </div>
                    <div class="progress-text">${progressoTexto}</div>
                </div>
            `;
        }

        // Carregar e renderizar certificados reais
        async function loadAndRenderCertificates() {
            if (!currentUser) return;

            console.log('üéì Buscando certificados do aluno...');

            try {
                const { data: certificados, error } = await supabaseClient
                    .from('certificados')
                    .select(`
                        *,
                        cursos (titulo)
                    `)
                    .eq('aluno_id', currentUser.id)
                    .order('data_emissao', { ascending: false });

                if (error) {
                    console.error('Erro ao carregar certificados:', error);
                    return;
                }

                console.log('üìú Certificados encontrados:', certificados);

                const container = document.getElementById('certificadosContainer');

                if (!certificados || certificados.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">Nenhum certificado dispon√≠vel ainda.</p>';
                    return;
                }

                const certificadosHTML = certificados.map(cert => {
                    const dataEmissao = new Date(cert.data_emissao).toLocaleDateString('pt-BR');

                    return `
                        <div class="certificate-item">
                            <div class="certificate-info">
                                <h3>${cert.cursos?.titulo || 'Curso'}</h3>
                                <div class="certificate-date">Emitido em ${dataEmissao}</div>
                            </div>
                            <button class="btn btn-download" onclick="downloadCertificate('${cert.id}', '${cert.arquivo_path}')">Baixar PDF</button>
                        </div>
                    `;
                }).join('');

                container.innerHTML = certificadosHTML;

            } catch (err) {
                console.error('Erro ao carregar certificados:', err);
            }
        }

        // Renderizar certificados (manter para compatibilidade - mas agora busca dados reais)
        async function renderCertificates(matriculas) {
            await loadAndRenderCertificates();
        }

        // Download de certificado
        async function downloadCertificate(certificadoId, arquivoPath) {
            console.log('üìú Baixando certificado:', { certificadoId, arquivoPath });

            if (!arquivoPath) {
                alert('Caminho do certificado n√£o encontrado.');
                return;
            }

            showLoading('Preparando download...');

            try {
                // Criar URL assinada para download seguro
                const { data, error } = await supabaseClient
                    .storage
                    .from('course-materials')
                    .createSignedUrl(arquivoPath, 60); // 60 segundos

                hideLoading();

                if (error) {
                    console.error('Erro ao gerar URL de download:', error);
                    alert('Erro ao preparar download. Tente novamente.');
                    return;
                }

                if (data && data.signedUrl) {
                    // Abrir em nova aba
                    window.open(data.signedUrl, '_blank');
                } else {
                    alert('Erro ao gerar link de download.');
                }

            } catch (err) {
                hideLoading();
                console.error('Erro no download:', err);
                alert('Erro ao fazer download. Tente novamente.');
            }
        }

        // Atualizar perfil
        async function handleProfileUpdate(event) {
            event.preventDefault();

            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            const city = document.getElementById('profileCity').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            showLoading('Salvando altera√ß√µes...');

            try {
                // Atualizar auth metadata
                const { data: authData, error: authError } = await supabaseClient.auth.updateUser({
                    data: {
                        full_name: name,
                        phone: phone,
                        city: city
                    }
                });

                if (authError) throw authError;

                // Atualizar ou inserir no banco de dados
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .upsert({
                        id: currentUser.id,
                        full_name: name,
                        phone: phone,
                        city: city,
                        email: currentUser.email,
                        updated_at: new Date().toISOString()
                    });

                if (profileError) {
                    console.error('Erro ao atualizar perfil no banco:', profileError);
                }

                hideLoading();
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');

                showAlert('profileAlert', 'Perfil atualizado com sucesso!', true);
                currentUser = authData.user;

                // Atualizar header
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();

            } catch (err) {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
                showAlert('profileAlert', 'Erro ao atualizar perfil. Tente novamente.', false);
                console.error('Erro:', err);
            }
        }

        // Alternar entre abas
        function switchTab(tabName) {
            // Remover active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Adicionar active na aba selecionada
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
    </script>
</body>
</html>